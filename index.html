<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer - Supply Chain </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .wallet-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4a5568;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status.info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .section h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }
        
        .product-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .product-info {
            margin-bottom: 8px;
            color: #4a5568;
        }
        
        .supplier-address {
            font-family: monospace;
            background: #f7fafc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            word-break: break-all;
        }
        
        .request-form {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e6edff;
            margin-top: 15px;
        }
        
        .requests-list {
            margin-top: 20px;
        }
        
        .request-item {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px solid #feb2b2;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí Customer </h1>
            <p>Qu·∫£n l√Ω mua h√†ng t·ª´ Supply Chain</p>
        </div>

        <!-- Wallet Connection Section -->
        <div class="wallet-section">
            <h2>üîê K·∫øt n·ªëi v√≠</h2>
            <div class="form-group">
                <label for="rpcUrl">RPC URL:</label>
                <input type="text" id="rpcUrl" placeholder="https://rpc-url.com" value="http://localhost:8545">
            </div>
            <div class="form-group">
                <label for="contractAddress">Contract Address:</label>
                <input type="text" id="contractAddress" placeholder="0x...">
            </div>
            <div class="form-group">
                <label for="privateKey">Private Key:</label>
                <input type="password" id="privateKey" placeholder="0x...">
            </div>
            <button class="btn" onclick="connectWallet()">K·∫øt n·ªëi v√≠</button>
            <div id="walletStatus"></div>
        </div>

        <!-- Products Section -->
        <div class="section">
            <h2>üì¶ Danh s√°ch s·∫£n ph·∫©m</h2>
            <button class="btn" onclick="loadProducts()">T·∫£i danh s√°ch s·∫£n ph·∫©m</button>
            <div id="productsContainer">
                <div class="loading">Nh·∫•n "T·∫£i danh s√°ch s·∫£n ph·∫©m" ƒë·ªÉ xem c√°c s·∫£n ph·∫©m c√≥ s·∫µn</div>
            </div>
        </div>

        <!-- Purchase Request Section -->
        <div class="section">
            <h2>üõçÔ∏è T·∫°o y√™u c·∫ßu mua h√†ng</h2>
            <div class="request-form">
                <div class="grid-2">
                    <div class="form-group">
                        <label for="supplierAddress">ƒê·ªãa ch·ªâ Supplier:</label>
                        <input type="text" id="supplierAddress" placeholder="0x...">
                    </div>
                    <div class="form-group">
                        <label for="productName">T√™n s·∫£n ph·∫©m:</label>
                        <input type="text" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m">
                    </div>
                    <div class="form-group">
                        <label for="quantity">S·ªë l∆∞·ª£ng:</label>
                        <input type="number" id="quantity" placeholder="1" min="1">
                    </div>
                    <div class="form-group">
                        <label for="maxPrice">Gi√° t·ªëi ƒëa m·ªói ƒë∆°n v·ªã (Wei):</label>
                        <input type="number" id="maxPrice" placeholder="1000000000000000000">
                    </div>
                </div>
                <div class="form-group">
                    <label for="deliveryAddress">ƒê·ªãa ch·ªâ giao h√†ng:</label>
                    <textarea id="deliveryAddress" rows="3" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng"></textarea>
                </div>
                <button class="btn" onclick="checkAvailability()">Ki·ªÉm tra t·ªìn kho</button>
                <button class="btn" onclick="createPurchaseRequest()">T·∫°o y√™u c·∫ßu mua h√†ng</button>
                <div id="availabilityResult"></div>
            </div>
        </div>

        <!-- My Requests Section -->
        <div class="section">
            <h2>üìã Y√™u c·∫ßu mua h√†ng c·ªßa t√¥i</h2>
            <button class="btn" onclick="loadMyRequests()">T·∫£i y√™u c·∫ßu c·ªßa t√¥i</button>
            <div id="requestsContainer">
                <div class="loading">Nh·∫•n "T·∫£i y√™u c·∫ßu c·ªßa t√¥i" ƒë·ªÉ xem danh s√°ch y√™u c·∫ßu</div>
            </div>
        </div>
    </div>

    <script>
        let provider;
        let signer;
        let contract;
        let userAddress;
        
        const contractABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "DeliveryConfirmed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"name": "DeliveryUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManagerAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManagerRemoved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "OrderApproved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "customer",
				"type": "address"
			}
		],
		"name": "OrderPlaced",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			}
		],
		"name": "ProductAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "Refunded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "target",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"name": "ReviewSubmitted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "TransporterAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "TransporterRemoved",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "acceptQuotation",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "addManager",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "stock",
				"type": "uint256"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "addTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "transportFee",
				"type": "uint256"
			}
		],
		"name": "approveOrder",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "cancelOrder",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "confirmReceipt",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "customerToRequests",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "deliveries",
		"outputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllProducts",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "unitPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "stock",
						"type": "uint256"
					}
				],
				"internalType": "struct SupplyChainSystem.Product[]",
				"name": "",
				"type": "tuple[]"
			},
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllRequests",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "id",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "customer",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "supplier",
						"type": "address"
					},
					{
						"internalType": "string",
						"name": "productName",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "quantity",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "maxUnitPrice",
						"type": "uint256"
					},
					{
						"internalType": "string",
						"name": "deliveryAddress",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "timestamp",
						"type": "uint256"
					},
					{
						"internalType": "enum SupplyChainSystem.RequestStatus",
						"name": "status",
						"type": "uint8"
					}
				],
				"internalType": "struct SupplyChainSystem.PurchaseRequest[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			}
		],
		"name": "getCustomerRequests",
		"outputs": [
			{
				"internalType": "uint256[]",
				"name": "",
				"type": "uint256[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "getDelivery",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "transporter",
						"type": "address"
					},
					{
						"internalType": "enum SupplyChainSystem.DeliveryStage",
						"name": "stage",
						"type": "uint8"
					}
				],
				"internalType": "struct SupplyChainSystem.DeliveryInfo",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "getPayment",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "customer",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "supplier",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "transporter",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "supplierAmount",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "transportFee",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "settled",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "refunded",
						"type": "bool"
					}
				],
				"internalType": "struct SupplyChainSystem.Payment",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			}
		],
		"name": "getSupplierProducts",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "unitPrice",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "stock",
						"type": "uint256"
					}
				],
				"internalType": "struct SupplyChainSystem.Product[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			}
		],
		"name": "getSupplierReviews",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint8",
						"name": "rating",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "comment",
						"type": "string"
					}
				],
				"internalType": "struct SupplyChainSystem.Review[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			}
		],
		"name": "getTransporterReviews",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint8",
						"name": "rating",
						"type": "uint8"
					},
					{
						"internalType": "string",
						"name": "comment",
						"type": "string"
					}
				],
				"internalType": "struct SupplyChainSystem.Review[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "isManager",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "isTransporter",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"name": "leaveReview",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "offeredPrices",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "paidAmounts",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "payments",
		"outputs": [
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "transporter",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "supplierAmount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "transportFee",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "settled",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "refunded",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxUnitPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "deliveryAddress",
				"type": "string"
			}
		],
		"name": "placeOrder",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			}
		],
		"name": "processRefund",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "removeManager",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "removeTransporter",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "requests",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "id",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "customer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "supplier",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "productName",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "quantity",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "maxUnitPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "deliveryAddress",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"internalType": "enum SupplyChainSystem.RequestStatus",
				"name": "status",
				"type": "uint8"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			}
		],
		"name": "sendQuotation",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "supplierProducts",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "unitPrice",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "stock",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "supplierReviews",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "suppliers",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "transporterReviews",
		"outputs": [
			{
				"internalType": "uint8",
				"name": "rating",
				"type": "uint8"
			},
			{
				"internalType": "string",
				"name": "comment",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "requestId",
				"type": "uint256"
			},
			{
				"internalType": "enum SupplyChainSystem.DeliveryStage",
				"name": "stage",
				"type": "uint8"
			}
		],
		"name": "updateDeliveryStage",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
];

        function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('walletStatus');
    statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
}

async function connectWallet() {
    try {
        const rpcUrl = document.getElementById('rpcUrl').value;
        const contractAddress = document.getElementById('contractAddress').value;
        const privateKey = document.getElementById('privateKey').value;

        if (!rpcUrl || !contractAddress || !privateKey) {
            showStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
            return;
        }

        // K·∫øt n·ªëi v·ªõi provider
        provider = new ethers.JsonRpcProvider(rpcUrl);
        
        // T·∫°o wallet t·ª´ private key
        signer = new ethers.Wallet(privateKey, provider);
        userAddress = await signer.getAddress();
        
        // T·∫°o contract instance
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        
        // Ki·ªÉm tra k·∫øt n·ªëi
        const balance = await provider.getBalance(userAddress);
        
        showStatus(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!<br>
                   üìç ƒê·ªãa ch·ªâ: ${userAddress}<br>
                   üí∞ S·ªë d∆∞: ${ethers.formatEther(balance)} ETH`, 'success');
        
    } catch (error) {
        console.error('L·ªói k·∫øt n·ªëi:', error);
        showStatus(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
    }
}

async function loadProducts() {
    if (!contract) {
        showStatus('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!', 'error');
        return;
    }

    try {
        document.getElementById('productsContainer').innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
        
        const [products, suppliers] = await contract.getAllProducts();

        if (products.length === 0) {
            document.getElementById('productsContainer').innerHTML = '<div class="loading">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</div>';
            return;
        }

        let html = '<div class="products-grid">';
        products.forEach((product, index) => {
            const supplier = suppliers[index];
            html += `
                <div class="product-card">
                    <div class="product-name">üì¶ ${product.name}</div>
                    <div class="product-info"><strong>Supplier:</strong> 
                        <span class="supplier-address">${supplier}</span>
                    </div>
                    <div class="product-info"><strong>Gi√° m·ªói ƒë∆°n v·ªã:</strong> ${ethers.formatEther(product.unitPrice)} ETH</div>
                    <div class="product-info"><strong>S·ªë l∆∞·ª£ng:</strong> ${product.stock}</div>
                    <button class="btn" onclick="fillRequestForm('${supplier}', '${product.name}', ${product.stock})">
                        T·∫°o y√™u c·∫ßu mua
                    </button>
                </div>
            `;
        });
        html += '</div>';

        document.getElementById('productsContainer').innerHTML = html;

    } catch (error) {
        console.error('L·ªói t·∫£i s·∫£n ph·∫©m:', error);
        document.getElementById('productsContainer').innerHTML = 
            `<div class="status error">‚ùå L·ªói t·∫£i s·∫£n ph·∫©m: ${error.message}</div>`;
    }
}

function fillRequestForm(supplier, productName, availableQuantity) {
    document.getElementById('supplierAddress').value = supplier;
    document.getElementById('productName').value = productName;
    document.getElementById('quantity').max = availableQuantity;
    
    // Scroll to form
    document.querySelector('.request-form').scrollIntoView({ behavior: 'smooth' });
    
    showStatus(`‚úÖ ƒê√£ ƒëi·ªÅn th√¥ng tin s·∫£n ph·∫©m "${productName}" t·ª´ supplier ${supplier.slice(0,10)}...`, 'success');
}

async function checkAvailability() {
    if (!contract) {
        showStatus('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!', 'error');
        return;
    }

    try {
        const supplier = document.getElementById('supplierAddress').value;
        const productName = document.getElementById('productName').value;
        const requestedQuantity = parseInt(document.getElementById('quantity').value);

        if (!supplier || !productName || !requestedQuantity) {
            document.getElementById('availabilityResult').innerHTML = 
                '<div class="status error">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!</div>';
            return;
        }

        const [productList, supplierList] = await contract.getAllProducts();
        let totalAvailable = 0;
        let supplierProducts = [];

        productList.forEach((product, index) => {
            const thisSupplier = supplierList[index];
            if (thisSupplier.toLowerCase() === supplier.toLowerCase() &&
                product.name.toLowerCase() === productName.toLowerCase()) {

                totalAvailable += Number(product.stock);
                supplierProducts.push({
                    id: index,
                    quantity: Number(product.stock),
                    timestamp: 0
                });
            }
        });

        let resultHtml = '';
        if (totalAvailable === 0) {
            resultHtml = `<div class="status error">‚ùå Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m "${productName}" t·ª´ supplier n√†y!</div>`;
        } else if (totalAvailable < requestedQuantity) {
            resultHtml = `<div class="status error">‚ùå Kh√¥ng ƒë·ªß h√†ng! C√≥ s·∫µn: ${totalAvailable}, Y√™u c·∫ßu: ${requestedQuantity}</div>`;
        } else {
            resultHtml = `<div class="status success">‚úÖ ƒê·ªß h√†ng! C√≥ s·∫µn: ${totalAvailable}, Y√™u c·∫ßu: ${requestedQuantity}</div>`;
            
            // Hi·ªÉn th·ªã chi ti·∫øt c√°c batch
            if (supplierProducts.length > 1) {
                resultHtml += '<div class="status info"><strong>Chi ti·∫øt batch:</strong><br>';
                supplierProducts.forEach((item, index) => {
                    const date = new Date(item.timestamp * 1000).toLocaleDateString('vi-VN');
                    resultHtml += `‚Ä¢ Batch ${index + 1}: ${item.quantity} ƒë∆°n v·ªã (${date})<br>`;
                });
                resultHtml += '</div>';
            }
        }

        document.getElementById('availabilityResult').innerHTML = resultHtml;

    } catch (error) {
        console.error('L·ªói ki·ªÉm tra t·ªìn kho:', error);
        document.getElementById('availabilityResult').innerHTML = 
            `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
    }
}

async function createPurchaseRequest() {
    if (!contract) {
        showStatus('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!', 'error');
        return;
    }

    try {
        const supplier = document.getElementById('supplierAddress').value;
        const productName = document.getElementById('productName').value;
        const quantity = parseInt(document.getElementById('quantity').value);
        const maxPrice = document.getElementById('maxPrice').value;
        const deliveryAddress = document.getElementById('deliveryAddress').value;

        if (!supplier || !productName || !quantity || !maxPrice || !deliveryAddress) {
            document.getElementById('availabilityResult').innerHTML = 
                '<div class="status error">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!</div>';
            return;
        }

        document.getElementById('availabilityResult').innerHTML = 
            '<div class="status info">‚è≥ ƒêang g·ª≠i y√™u c·∫ßu...</div>';

        const tx = await contract.placeOrder(
            supplier,
            productName,
            quantity,
            maxPrice,
            deliveryAddress,
            { value: BigInt(maxPrice) * BigInt(quantity) }
        );

        document.getElementById('availabilityResult').innerHTML = 
            '<div class="status info">‚è≥ ƒêang ch·ªù x√°c nh·∫≠n transaction...</div>';

        const receipt = await tx.wait();

        document.getElementById('availabilityResult').innerHTML = 
            `<div class="status success">‚úÖ Y√™u c·∫ßu mua h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!<br>
             üìÑ TX Hash: ${receipt.hash}</div>`;

        // Clear form
        document.getElementById('supplierAddress').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('quantity').value = '';
        document.getElementById('maxPrice').value = '';
        document.getElementById('deliveryAddress').value = '';

    } catch (error) {
        console.error('L·ªói t·∫°o y√™u c·∫ßu:', error);
        document.getElementById('availabilityResult').innerHTML = 
            `<div class="status error">‚ùå L·ªói: ${error.message}</div>`;
    }
}

async function acceptQuotation(requestId) {
    try {
        const tx = await contract.acceptQuotation(requestId);
        await tx.wait();
        console.log("Quotation accepted for request:", requestId);
        alert("B·∫°n ƒë√£ ƒë·ªìng √Ω b√°o gi√° th√†nh c√¥ng!");
        loadMyRequests(); // Refresh danh s√°ch
    } catch (error) {
        console.error("L·ªói khi ƒë·ªìng √Ω b√°o gi√°:", error);
        alert("Kh√¥ng th·ªÉ ƒë·ªìng √Ω b√°o gi√°. Vui l√≤ng th·ª≠ l·∫°i.");
    }
}

async function rejectQuotation(requestId) {
    try {
        const tx = await contract.rejectQuotation(requestId);
        await tx.wait();
        alert("üö´ ƒê√£ t·ª´ ch·ªëi b√°o gi√°.");
        loadMyRequests();
    } catch (err) {
        console.error(err);
        alert("‚ùå L·ªói khi t·ª´ ch·ªëi.");
    }
}
async function confirmDelivery(requestId) {
    if (!contract) {
        showStatus('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!', 'error');
        return;
    }

    try {
        const deliveryInfo = await contract.getDelivery(requestId);
        const request = await contract.requests(requestId);
        const payment = await contract.getPayment(requestId);

        if (request.customer.toLowerCase() !== userAddress.toLowerCase()) {
            alert("‚ùå ƒê√¢y kh√¥ng ph·∫£i ƒë∆°n h√†ng c·ªßa b·∫°n!");
            return;
        }

        if (Number(deliveryInfo.stage) !== 2) {
            alert("‚ùå ƒê∆°n h√†ng ch∆∞a ƒë∆∞·ª£c giao ƒë·∫øn b·∫°n!");
            return;
        }

        if (payment.settled) {
            alert("‚ö†Ô∏è ƒê∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n v√† thanh to√°n r·ªìi!");
            return;
        }

        const totalPaid = await provider.getBalance(contract.target); // b·∫°n c√≥ th·ªÉ l∆∞u t·ªïng ti·ªÅn kh√°ch ƒë√£ g·ª≠i t·ª´ client
        const totalCost = BigInt(payment.supplierAmount) + BigInt(payment.transportFee);
        const refundAmount = totalPaid - totalCost;

        const confirmResult = confirm(
            `üöö X√°c nh·∫≠n b·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ƒë∆°n h√†ng #${requestId}?\n\n` +
            `üì¶ S·∫£n ph·∫©m: ${request.productName}\n` +
            `üî¢ S·ªë l∆∞·ª£ng: ${request.quantity}\n` +
            `üí∞ T·ªïng ti·ªÅn: ${ethers.formatEther(payment.supplierAmount)} ETH\n` +
            `üöõ Ph√≠ v·∫≠n chuy·ªÉn: ${ethers.formatEther(payment.transportFee)} ETH\n` +
            `üîÑ Ho√†n l·∫°i: ${ethers.formatEther(refundAmount)} ETH\n\n` +
            `‚ö†Ô∏è Sau khi x√°c nh·∫≠n, ti·ªÅn s·∫Ω ƒë∆∞·ª£c chuy·ªÉn cho supplier v√† transporter,\n` +
            `v√† ph·∫ßn d∆∞ s·∫Ω ƒë∆∞·ª£c ho√†n v·ªÅ v√≠ c·ªßa b·∫°n.`
        );

        if (!confirmResult) return;

        showStatus('‚è≥ ƒêang x√°c nh·∫≠n giao h√†ng...', 'info');
        const tx = await contract.confirmReceipt(requestId);
        showStatus('‚è≥ ƒêang ch·ªù x√°c nh·∫≠n transaction...', 'info');
        const receipt = await tx.wait();

        showStatus(
            `‚úÖ ƒê√£ x√°c nh·∫≠n giao h√†ng th√†nh c√¥ng!<br>
             üí∞ ƒê√£ thanh to√°n v√† ho√†n l·∫°i ph·∫ßn d∆∞<br>
             üìÑ TX Hash: ${receipt.hash}`, 
            'success'
        );

        loadMyRequests();
        alert("üéâ C·∫£m ∆°n b·∫°n! Giao h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n v√† ho√†n ti·ªÅn d∆∞ th√†nh c√¥ng.");
    } catch (error) {
        console.error('L·ªói x√°c nh·∫≠n giao h√†ng:', error);
        let errorMessage = "‚ùå L·ªói x√°c nh·∫≠n giao h√†ng: ";

        if (error.message.includes("Not delivered")) {
            errorMessage += "ƒê∆°n h√†ng ch∆∞a ƒë∆∞·ª£c giao!";
        } else if (error.message.includes("Already settled")) {
            errorMessage += "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n r·ªìi!";
        } else if (error.message.includes("Not your request")) {
            errorMessage += "ƒê√¢y kh√¥ng ph·∫£i ƒë∆°n h√†ng c·ªßa b·∫°n!";
        } else {
            errorMessage += error.message;
        }

        showStatus(errorMessage, 'error');
        alert(errorMessage);
    }
}


// üÜï FUNCTION KI·ªÇM TRA TR·∫†NG TH√ÅI GIAO H√ÄNG
async function checkDeliveryStatus(requestId) {
    if (!contract) {
        showStatus('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!', 'error');
        return;
    }

    try {
        const deliveryInfo = await contract.getDelivery(requestId);
        const request = await contract.requests(requestId);
        
        let stageText = "";
        switch (Number(deliveryInfo.stage)) {
            case 0: stageText = "üîÑ ƒêang chu·∫©n b·ªã h√†ng"; break;
            case 1: stageText = "üöö ƒê√£ l·∫•y h√†ng, ƒëang v·∫≠n chuy·ªÉn"; break;
            case 2: stageText = "üì¶ ƒê√£ giao ƒë·∫øn ƒë·ªãa ch·ªâ"; break;
            default: stageText = "‚ùì Kh√¥ng r√µ tr·∫°ng th√°i";
        }
        
        const info = `
            üìã Tr·∫°ng th√°i giao h√†ng ƒë∆°n #${requestId}:
            ${stageText}
            
            üöõ Transporter: ${deliveryInfo.transporter}
            üì¶ S·∫£n ph·∫©m: ${request.productName}
            üìç ƒê·ªãa ch·ªâ giao: ${request.deliveryAddress}
        `;
        
        alert(info);
        
    } catch (error) {
        console.error('L·ªói ki·ªÉm tra tr·∫°ng th√°i:', error);
        alert(`‚ùå L·ªói ki·ªÉm tra tr·∫°ng th√°i: ${error.message}`);
    }
}

function getStatusText(status) {
    switch (status) {
        case 0: return "Ch·ªù x·ª≠ l√Ω";             // Pending
        case 1: return "ƒê√£ b√°o gi√°";            // Quoted
        case 2: return "Kh√°ch ƒë√£ ƒë·ªìng √Ω";       // AcceptedByCustomer
        case 3: return "ƒê∆∞·ª£c duy·ªát b·ªüi Manager";// Approved
        case 4: return "ƒê√£ giao th√†nh c√¥ng";     // Delivered
        case 5: return "Th·∫•t b·∫°i / ƒê√£ h·ªßy";      // Failed
        case 6: return "ƒê√£ ho√†n ti·ªÅn";           // Refunded
        default: return "Kh√¥ng r√µ";
    }
}

async function loadMyRequests() {
    if (!contract) {
        showStatus('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!', 'error');
        return;
    }

    try {
        const ids = await contract.getCustomerRequests(userAddress);
        let html = '';

        for (let id of ids) {
            const req = await contract.requests(id);
            const offeredPrice = await contract.offeredPrices(id);
            const status = Number(req.status);

            html += `
                <div class="request-item">
                    <p><strong>üÜî ID:</strong> ${id}</p>
                    <p><strong>üì¶ S·∫£n ph·∫©m:</strong> ${req.productName}</p>
                    <p><strong>üî¢ S·ªë l∆∞·ª£ng:</strong> ${req.quantity}</p>
                    <p><strong>üí∞ Gi√° t·ªëi ƒëa 1 ƒë∆°n v·ªã:</strong> ${req.maxUnitPrice} Wei</p>
                    <p><strong>üìå Tr·∫°ng th√°i:</strong> ${getStatusText(status)}</p>
                    <p><strong>üí¨ Gi√° ƒë∆∞·ª£c b√°o 1 ƒë∆°n v·ªã:</strong> ${Number(offeredPrice)} Wei</p>
                    <p><strong>üìç ƒê·ªãa ch·ªâ giao:</strong> ${req.deliveryAddress}</p>
            `;

            // N√∫t h√†nh ƒë·ªông theo tr·∫°ng th√°i
            if (status === 1) { // Quoted
                html += `
                    <button class="btn" onclick="acceptQuotation(${id})">‚úÖ ƒê·ªìng √Ω</button>
                    <button class="btn" onclick="rejectQuotation(${id})">‚ùå T·ª´ ch·ªëi</button>
                `;
            } else if (status === 3) { // Approved - ƒëang giao h√†ng
                html += `
                    <button class="btn" onclick="checkDeliveryStatus(${id})">üìç Ki·ªÉm tra tr·∫°ng th√°i giao h√†ng</button>
                    <button class="btn" onclick="confirmDelivery(${id})">üì¶ X√°c nh·∫≠n ƒë√£ nh·∫≠n h√†ng</button>
                `;
            } else if (status === 4) { // Delivered
                html += `
                    <div class="status success">‚úÖ ƒê√£ ho√†n th√†nh v√† thanh to√°n</div>
                `;
            }

            html += `</div>`;
        }

        document.getElementById("requestsContainer").innerHTML = html || `<div class="status info">üì≠ Kh√¥ng c√≥ y√™u c·∫ßu n√†o.</div>`;
    } catch (err) {
        console.error(err);
        document.getElementById("requestsContainer").innerHTML = `<div class="status error">‚ùå L·ªói khi t·∫£i y√™u c·∫ßu: ${err.message}</div>`;
    }
}

// Auto-fill example data for testing
window.addEventListener('load', function() {
    // Uncomment these lines for testing
    // document.getElementById('rpcUrl').value = 'http://localhost:8545';
    // document.getElementById('contractAddress').value = '0x...'; // Your contract address
    // document.getElementById('privateKey').value = '0x...'; // Your test private key
});
    </script>
</body>
</html>
